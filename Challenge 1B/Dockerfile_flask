# Use an official Python runtime as a parent image.
FROM python:3.12-slim-bullseye

# Set environment variables for better Docker build behavior and model caching.
ENV PYTHONUNBUFFERED=1
ENV TRANSFORMERS_CACHE=/app/huggingface_cache
ENV DEBIAN_FRONTEND=noninteractive

# Set the working directory inside the container.
WORKDIR /app

# Install system-level dependencies.
# These are needed for PyMuPDF, pytesseract, and pdf2image.
RUN apt-get update && apt-get install -y --no-install-recommends \
    libglib2.0-0 \
    tesseract-ocr \
    poppler-utils \
    libleptonica-dev \
    libpoppler-glib-dev \
    imagemagick \
    && rm -rf /var/lib/apt/lists/* # Clean up apt lists to reduce image size

# Copy the requirements file into the container.
COPY requirements.txt .

# Install Python dependencies.
# This includes Flask, our core NLP/PDF libraries, and dependencies for teammate's app.
RUN pip install --no-cache-dir -r requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu

# Download the Sentence-Transformer model.
# This ensures the model is present inside the image when the container runs,
# eliminating the need for internet access at runtime.
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('paraphrase-multilingual-MiniLM-L12-v2')"

# Copy your teammate's application code and model files into the container.
# This assumes your 'adobe_repo' folder is at the root of your project on the host.
COPY adobe_repo /app/adobe_repo/ 

# Copy your Flask application and HTML templates.
COPY app.py /app/
COPY templates/ /app/templates/

# Copy your main document processing script.
COPY pdf_processor.py /app/

# Expose the port Flask will run on (default is 5000).
EXPOSE 5000

# Define the command to run the Flask application.
# For development, you can use 'flask run --host=0.0.0.0'.
# For production, a WSGI server like Gunicorn is recommended (e.g., 'gunicorn -w 4 -b 0.0.0.0:5000 app:app').
# We'll use the simpler 'flask run' for now.
CMD ["flask", "run", "--host=0.0.0.0"]